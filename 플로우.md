# Hunyuan3D-2: 2D 이미지 → 3D 모델 변환 플로우

## 📋 전체 파이프라인 개요

```
입력 이미지 (2D)
    ↓
[1] 이미지 전처리 (배경 제거)
    ↓
[2] 형상 생성 파이프라인 (Shape Generation)
    ↓
3D 메쉬 (형상만, 텍스처 없음)
    ↓
[3] 텍스처 생성 파이프라인 (Texture Generation)
    ↓
최종 3D 모델 (.glb 파일)
```

---

## 🔧 단계별 상세 플로우

### 📌 Phase 0: 이미지 전처리

**목적**: 입력 이미지를 3D 생성에 적합한 형태로 변환

**프로세스**:
```
입력 이미지
    ↓
[모드 확인] RGB / RGBA / Grayscale
    ↓
[배경 제거] (옵션) - rembg 라이브러리 사용
    ↓
RGBA 형식으로 변환
```

**영향 요소**:
- `REMOVE_BACKGROUND` (True/False): 배경 제거 활성화 여부
- 입력 이미지 해상도: 고해상도일수록 디테일 향상
- 이미지 품질: 선명도, 조명, 각도

**소요 시간**: ~1초

---

### 📌 Phase 1: 형상 생성 (Shape Generation)

**사용 모델**: Hunyuan3DDiTFlowMatchingPipeline
- **아키텍처**: DiT (Diffusion Transformer) + Flow Matching
- **서브모델**: hunyuan3d-dit-v2-0-turbo
- **정밀도**: torch.float16 (GPU 메모리 절약)

**프로세스**:
```
전처리된 이미지 (RGBA)
    ↓
[DiT Encoder] 이미지 → 잠재 공간 (latent space)
    ↓
[Flow Matching 반복] num_inference_steps 만큼
    ↓
[Octree 기반 복셀화] octree_resolution 설정
    ↓
[메쉬 추출] Marching Cubes 알고리즘
    ↓
3D 메쉬 (정점 + 면, UV 매핑 없음)
```

**주요 입력 파라미터**:

1. **NUM_INFERENCE_STEPS** (기본값: 5)
   - 범위: 3-10
   - 영향: 추론 단계 수 (Diffusion 반복 횟수)
   - 높을수록: 더 정확한 형상, 느린 속도
   - 낮을수록: 빠른 생성, 덜 정밀한 형상
   - **권장**: 5 (turbo 모델 최적화 값)

2. **OCTREE_RESOLUTION** (기본값: 192)
   - 범위: 128, 192, 256
   - 영향: 3D 복셀 해상도
   - 128: 빠름, 낮은 디테일, ~55,000 면
   - 192: 균형 (권장), 중간 디테일, ~111,000 면
   - 256: 느림, 높은 디테일, ~448,000 면
   - **주의**: 높을수록 UV 래핑 시간 증가 (지수적)

3. **GUIDANCE_SCALE** (기본값: 5)
   - 범위: 3-10
   - 영향: 입력 이미지 충실도 vs 생성 다양성
   - 낮을수록: 더 창의적, 원본과 다를 수 있음
   - 높을수록: 원본 이미지에 충실, 과적합 가능
   - **권장**: 5 (안정적인 균형)

**출력**: trimesh.Trimesh 객체 (정점, 면, 법선 벡터)

**소요 시간**: ~5-10초 (설정에 따라)

---

### 📌 Phase 2: 텍스처 생성 (Texture Generation)

**사용 모델**: Hunyuan3DPaintPipeline
- **서브모델**: hunyuan3d-paint-v2-0-turbo
- **구성 요소**: 
  - Delight Model (Stable Diffusion InstructPix2Pix)
  - Multiview Model (커스텀 Diffusion)
  - Differentiable Renderer

**11단계 상세 프로세스**:

#### 🎯 Stage 1: 이미지 중앙 정렬 (Image Recenter)
```
입력 이미지 → 중심 크롭 및 정렬
```
- **소요 시간**: ~0.00초
- **영향**: 없음 (자동 처리)

#### 🎯 Stage 2: Delight 모델 (그림자/하이라이트 제거)
```
이미지 → [StableDiffusion InstructPix2Pix] → 균일한 조명 이미지
```
- **목적**: 원본 이미지의 조명 효과 제거 → 순수 색상 추출
- **모델**: Stable Diffusion InstructPix2Pix
- **입력 파라미터**:
  - `DELIGHT_INFERENCE_STEPS` (기본값: 6)
  - 범위: 4-10
  - 높을수록: 더 정밀한 조명 제거, 느린 속도
  - **권장**: 6 (turbo 모델 최적화)
- **소요 시간**: ~15-19초
- **비중**: 4.4%

#### 🎯 Stage 3: UV 래핑 (UV Wrapping)
```
3D 메쉬 → [xatlas 라이브러리] → UV 좌표 생성
```
- **목적**: 3D 표면을 2D 평면으로 펼침 (텍스처 맵핑 준비)
- **알고리즘**: xatlas (자동 UV 파라메터화)
- **영향 요소**:
  - 메쉬 복잡도 (면 개수)
  - OCTREE_RESOLUTION에 직접 영향받음
    - 128: ~55,545 정점, 111,110 면 → ~22초
    - 192: ~111,000 면 → ~22-23초
    - 256: ~448,684 면 → ~90초 이상
- **소요 시간**: 22-95초 (해상도에 따라)
- **비중**: 5.2-11.8%

#### 🎯 Stage 4: 메쉬 로드 (Mesh Load)
```
UV 매핑된 메쉬 → 렌더러 메모리 로드
```
- **소요 시간**: ~0.07-0.21초
- **비중**: 0.0%

#### 🎯 Stage 5: Normal 맵 렌더링
```
3D 메쉬 → [다중 각도 렌더링] → Normal Map (법선 벡터)
```
- **목적**: 각 카메라 시점에서 표면 법선 벡터 추출
- **카메라 개수**: `CAMERA_VIEWS` 설정에 따름
- **영향 파라미터**:
  - `RENDER_SIZE` (2048 기본값)
  - 해상도가 높을수록 정밀하지만 느림
- **소요 시간**: ~4-7초
- **비중**: 0.6-1.7%

#### 🎯 Stage 6: Position 맵 렌더링
```
3D 메쉬 → [다중 각도 렌더링] → Position Map (3D 좌표)
```
- **목적**: 각 픽셀의 3D 공간 좌표 저장
- **소요 시간**: ~4-6초
- **비중**: 0.6-1.5%

#### 🎯 Stage 7: Multiview 모델 (다중 시점 텍스처 생성)
```
[Delight 이미지 + Normal Map + Position Map]
    ↓
[Multiview Diffusion Model] × 카메라 뷰 개수
    ↓
각 시점별 텍스처 이미지
```
- **목적**: 여러 각도에서 본 텍스처 이미지 생성
- **모델**: 커스텀 Multiview Diffusion Network
- **주요 입력 파라미터**:

  1. **MULTIVIEW_INFERENCE_STEPS** (기본값: 6)
     - 범위: 4-10
     - 각 뷰마다 반복되는 Diffusion 단계 수
     - **권장**: 6 (turbo 모델 최적화)

  2. **CAMERA_VIEWS** (기본값: 'standard')
     - 옵션:
       - **'minimal'**: 3뷰 (0°, 120°, 240°)
         - 가중치: [1, 0.3, 0.3]
         - 가장 빠름, 후면 품질 낮음
       - **'fast'**: 4뷰 (0°, 90°, 180°, 270°)
         - 고도: 수평면만 (0°)
         - 가중치: [1, 0.1, 0.5, 0.1]
         - 빠름, 상하면 누락
       - **'standard'**: 6뷰 (전후좌우 + 위아래)
         - 방위각: 0°, 90°, 180°, 270°, 0°, 180°
         - 고도: 0°, 0°, 0°, 0°, 90°, -90°
         - 가중치: [1, 0.1, 0.5, 0.1, 0.05, 0.05]
         - **권장**: 균형잡힌 품질

  3. **뷰 가중치 (View Weights)**
     - 정면(0°): 가중치 1.0 (가장 중요)
     - 후면(180°): 가중치 0.5
     - 측면: 가중치 0.1
     - 상하: 가중치 0.05

- **프로세스 타임라인**:
  ```
  각 카메라 뷰마다:
    1. 카메라 위치 설정
    2. Normal/Position 맵 선택
    3. Diffusion 모델 추론 (MULTIVIEW_INFERENCE_STEPS 반복)
    4. 생성된 텍스처 이미지 저장
  ```

- **소요 시간**: 
  - 3뷰: ~180초
  - 4뷰: ~240초
  - 6뷰: ~295-315초 (각 뷰당 ~30-40초)
- **비중**: 36.8-74.0% (전체 프로세스의 최대 병목)

#### 🎯 Stage 8: 이미지 리사이즈
```
생성된 텍스처 이미지들 → TEXTURE_SIZE로 리사이즈
```
- **파라미터**: `TEXTURE_SIZE` (기본값: 2048)
  - 옵션: 1024, 2048, 4096
  - 높을수록: 고해상도 텍스처, 큰 파일 크기
- **소요 시간**: ~0.18-0.19초
- **비중**: 0.0%

#### 🎯 Stage 9: 텍스처 베이킹 (Texture Baking)
```
[다중 시점 텍스처들] → [가중치 기반 블렌딩] → 단일 UV 텍스처 맵
```
- **목적**: 여러 각도의 텍스처를 UV 맵에 통합
- **방법**: 
  - 각 뷰의 가중치 적용
  - 픽셀별 색상 블렌딩
  - 보이지 않는 영역 마스크 생성
- **소요 시간**: ~21-25초
- **비중**: 2.7-5.8%

#### 🎯 Stage 10: 텍스처 인페인팅 (Texture Inpainting)
```
[UV 텍스처 맵 + 빈 영역 마스크] → [인페인팅] → 완성된 텍스처
```
- **목적**: 카메라로 보이지 않았던 영역 채우기
- **방법**: Diffusion 기반 이미지 인페인팅
- **소요 시간**: ~31-366초 (복잡도에 따라)
- **비중**: 7.3-45.6%

#### 🎯 Stage 11: 최종 메쉬 저장
```
[3D 메쉬 + 완성된 텍스처] → .glb 파일 내보내기
```
- **소요 시간**: ~0.11-0.12초
- **비중**: 0.0%

---

## 🎛️ 설정 파라미터 영향도 분석

### ⚡ 속도 최적화 (빠른 생성)
```python
NUM_INFERENCE_STEPS = 3          # 최소값
OCTREE_RESOLUTION = 128          # 낮은 해상도
GUIDANCE_SCALE = 5               # 기본값 유지
DELIGHT_INFERENCE_STEPS = 4      # 최소값
MULTIVIEW_INFERENCE_STEPS = 4    # 최소값
CAMERA_VIEWS = 'minimal'         # 3뷰만
RENDER_SIZE = 1024               # 낮은 해상도
TEXTURE_SIZE = 1024              # 낮은 해상도
```
**예상 시간**: ~200-250초
**품질**: 낮음 (프로토타입, 빠른 테스트용)

### ⚖️ 균형 설정 (권장)
```python
NUM_INFERENCE_STEPS = 5          # 기본값
OCTREE_RESOLUTION = 192          # 중간 해상도
GUIDANCE_SCALE = 5               # 기본값
DELIGHT_INFERENCE_STEPS = 6      # 기본값
MULTIVIEW_INFERENCE_STEPS = 6    # 기본값
CAMERA_VIEWS = 'fast'            # 4뷰 (상하면 제외)
RENDER_SIZE = 2048               # 기본값
TEXTURE_SIZE = 2048              # 기본값
```
**예상 시간**: ~350-400초
**품질**: 중상 (대부분의 용도에 적합)

### 🎨 최고 품질 (느린 생성)
```python
NUM_INFERENCE_STEPS = 8          # 높은 값
OCTREE_RESOLUTION = 256          # 최고 해상도
GUIDANCE_SCALE = 7               # 높은 충실도
DELIGHT_INFERENCE_STEPS = 10     # 최대값
MULTIVIEW_INFERENCE_STEPS = 10   # 최대값
CAMERA_VIEWS = 'standard'        # 6뷰 전체
RENDER_SIZE = 4096               # 최고 해상도
TEXTURE_SIZE = 4096              # 최고 해상도
```
**예상 시간**: ~1000-1500초 (16-25분)
**품질**: 최고 (최종 제작물, 프레젠테이션용)

---

## 📊 병목 구간 및 최적화 포인트

### 주요 병목 구간 (시간 비중)

1. **Multiview 모델**: 36.8-74.0%
   - 최적화: `CAMERA_VIEWS` 줄이기
   - 최적화: `MULTIVIEW_INFERENCE_STEPS` 감소

2. **텍스처 인페인팅**: 7.3-45.6%
   - 복잡도에 따라 가변적
   - 직접 제어 불가 (자동)

3. **UV 래핑**: 5.2-11.8%
   - 최적화: `OCTREE_RESOLUTION` 감소
   - 128: ~22초, 256: ~95초 (4배 차이)

4. **Delight 모델**: 1.9-4.4%
   - 최적화: `DELIGHT_INFERENCE_STEPS` 감소

### 최적화 우선순위

1. **1순위**: `CAMERA_VIEWS` (minimal/fast로 변경)
   - 효과: 시간 40-50% 단축
   - 트레이드오프: 후면/상하면 품질 저하

2. **2순위**: `OCTREE_RESOLUTION` (192 → 128)
   - 효과: UV 래핑 시간 절반, 형상 생성 빨라짐
   - 트레이드오프: 디테일 감소

3. **3순위**: `MULTIVIEW_INFERENCE_STEPS` (6 → 4)
   - 효과: Multiview 시간 30% 단축
   - 트레이드오프: 텍스처 품질 약간 저하

4. **4순위**: 렌더/텍스처 해상도 감소
   - 효과: 미미 (병목 아님)
   - 트레이드오프: 최종 텍스처 선명도

---

## 🖥️ GPU 메모리 사용량

### 메모리 프로필

```
파이프라인 로드 완료 후:
  - Shape Pipeline: ~3-4 GB
  - Paint Pipeline 로드: ~7-8 GB
  - 텍스처 생성 중: ~11-12 GB (피크)
```

### 모델별 메모리

1. **Shape Pipeline**:
   - DiT 모델: ~2.5 GB (float16)
   - 추론 시 임시 메모리: ~1-2 GB

2. **Paint Pipeline**:
   - Delight Model (SD InstructPix2Pix): ~4 GB
   - Multiview Model: ~3-4 GB
   - Renderer 버퍼: ~1 GB
   - 임시 텍스처 버퍼: ~1-2 GB

**권장 GPU**: NVIDIA RTX 3080 이상 (12GB+ VRAM)

---

## 📦 출력 파일 구조

### .glb 파일 내용

```
bag.glb
├── 3D 메쉬 데이터
│   ├── 정점 (Vertices)
│   ├── 면 (Faces/Triangles)
│   ├── 법선 벡터 (Normals)
│   └── UV 좌표 (UV Coordinates)
└── 텍스처 데이터
    └── Base Color Texture (PNG/JPEG 임베디드)
```

### 파일 크기

- **128 해상도 + 1024 텍스처**: ~5-10 MB
- **192 해상도 + 2048 텍스처**: ~15-25 MB (일반적)
- **256 해상도 + 4096 텍스처**: ~50-100 MB

---

## 🔬 기술 스택

### 핵심 라이브러리

1. **PyTorch**: 딥러닝 프레임워크
2. **Diffusers**: Stable Diffusion 파이프라인
3. **trimesh**: 3D 메쉬 처리
4. **xatlas**: UV 파라메터화
5. **rembg**: 배경 제거
6. **Pillow**: 이미지 처리

### 모델 아키텍처

1. **Shape Generation**:
   - DiT (Diffusion Transformer)
   - Flow Matching (ODE 기반 생성)

2. **Texture Generation**:
   - Stable Diffusion InstructPix2Pix (조명 제거)
   - Custom Multiview Diffusion (다중 시점 텍스처)
   - Differentiable Renderer (미분 가능 렌더링)

---

## 🎯 사용 시나리오별 권장 설정

### 시나리오 1: 빠른 프로토타입
**목적**: 빠른 시각화, 대략적인 형상 확인
```python
NUM_INFERENCE_STEPS = 3
OCTREE_RESOLUTION = 128
CAMERA_VIEWS = 'minimal'
DELIGHT_INFERENCE_STEPS = 4
MULTIVIEW_INFERENCE_STEPS = 4
```
⏱️ **시간**: ~3-4분

### 시나리오 2: 일반적인 사용
**목적**: 웹/앱 전시, SNS 공유
```python
NUM_INFERENCE_STEPS = 5
OCTREE_RESOLUTION = 192
CAMERA_VIEWS = 'fast'
DELIGHT_INFERENCE_STEPS = 6
MULTIVIEW_INFERENCE_STEPS = 6
```
⏱️ **시간**: ~6-8분

### 시나리오 3: 프레젠테이션/포트폴리오
**목적**: 고품질 결과물, 디테일 중요
```python
NUM_INFERENCE_STEPS = 5-8
OCTREE_RESOLUTION = 192-256
CAMERA_VIEWS = 'standard'
DELIGHT_INFERENCE_STEPS = 6-8
MULTIVIEW_INFERENCE_STEPS = 6-8
TEXTURE_SIZE = 2048-4096
```
⏱️ **시간**: ~10-15분

### 시나리오 4: 배치 처리
**목적**: 여러 이미지 자동 처리
```python
# color_batch.py 사용
NUM_INFERENCE_STEPS = 5
OCTREE_RESOLUTION = 192
CAMERA_VIEWS = 'fast'  # 시간 절약
```
⏱️ **시간**: 이미지당 ~6-8분

---

## 📈 성능 벤치마크

### 테스트 환경
- GPU: NVIDIA RTX 4090
- 입력: 512×512 RGB 이미지

### 결과 (평균)

| 설정 | Octree | Views | 형상 생성 | 텍스처 생성 | 총 시간 |
|------|--------|-------|----------|------------|---------|
| 빠름 | 128 | 3뷰 | 4초 | 180초 | 200초 |
| 균형 | 192 | 4뷰 | 5초 | 350초 | 380초 |
| 기본 | 192 | 6뷰 | 5초 | 420초 | 470초 |
| 고품질 | 256 | 6뷰 | 10초 | 800초 | 850초 |

---

## 🛠️ 문제 해결 (Troubleshooting)

### 메모리 부족 오류
**증상**: CUDA out of memory
**해결**:
1. `OCTREE_RESOLUTION` 감소
2. `RENDER_SIZE` / `TEXTURE_SIZE` 감소
3. `CAMERA_VIEWS` = 'minimal'

### 너무 느림
**증상**: 10분 이상 소요
**해결**:
1. `CAMERA_VIEWS` = 'fast' 또는 'minimal'
2. `MULTIVIEW_INFERENCE_STEPS` = 4
3. `OCTREE_RESOLUTION` = 128

### 품질이 낮음
**증상**: 흐릿하거나 디테일 부족
**해결**:
1. `OCTREE_RESOLUTION` = 256
2. `MULTIVIEW_INFERENCE_STEPS` = 8-10
3. `TEXTURE_SIZE` = 4096
4. `CAMERA_VIEWS` = 'standard'

### 후면이 이상함
**증상**: 뒷면 텍스처가 부자연스러움
**해결**:
1. `CAMERA_VIEWS` = 'standard' (6뷰 사용)
2. 입력 이미지를 여러 각도에서 촬영
3. 배경 제거 품질 개선

---

## 📝 로그 파일 구조

### 자동 생성되는 로그
경로: `my/log/{YYYYMMDD_HHMMSS}_{filename}.txt`

내용:
```
============================================================
Hunyuan3D-2 3D 모델 생성 로그
============================================================
생성 일시: 2025-11-01 12:34:56

============================================================
📊 GPU 상태 확인:
    - delight_model 디바이스: cuda:0
    - multiview_model 디바이스: cuda:0
    - GPU 메모리 사용: 11.47 GB
============================================================

============================================================
🔍 텍스처 생성 단계별 시간 분석
============================================================
  1_image_recenter         :   0.00초 (  0.0%)
  2_delight_model          :  18.69초 (  4.4%)
  3_uv_wrap                :  22.36초 (  5.2%)
  ...
============================================================

============================================================
📊 처리 시간 요약
============================================================
  이미지 전처리             :   1.03초 (  0.2%)
  파이프라인 로드            :  19.15초 (  4.1%)
  형상 생성               :  10.71초 (  2.3%)
  텍스처 생성              : 426.02초 ( 90.5%)
  파일 저장               :   0.48초 (  0.1%)
------------------------------------------------------------
  총 소요 시간             : 470.75초
============================================================

============================================================
⚙️  사용된 설정값
============================================================
  입력 이미지         : my/input/bag.jpg
  출력 파일          : my/output/bag.glb
  배경 제거          : 활성화
------------------------------------------------------------
  [형상 생성]
    추론 단계         : 5
    Octree 해상도     : 192
    가이던스 스케일    : 5
------------------------------------------------------------
  [텍스처 생성]
    Delight 추론 단계 : 6
    Multiview 추론 단계: 6
    카메라 뷰 모드     : standard
    렌더 해상도       : 2048 x 2048
    텍스처 해상도      : 2048 x 2048
============================================================
```

---

## 🔮 향후 개선 가능 영역

1. **병렬 처리**: 여러 카메라 뷰 동시 생성
2. **모델 압축**: INT8 양자화로 메모리 절약
3. **캐싱**: 중간 결과물 저장 및 재사용
4. **적응형 해상도**: 입력 이미지 복잡도에 따라 자동 조정
5. **부분 재생성**: 특정 영역만 다시 텍스처링

---

**작성일**: 2025-11-01
**버전**: Hunyuan3D-2 (hunyuan3d-dit-v2-0-turbo / hunyuan3d-paint-v2-0-turbo)
